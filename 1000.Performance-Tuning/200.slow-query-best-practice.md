|description||
|---|---|
|keywords| |
|version|V3.x,V4.x|
|content-type|How-to|
|issue-type||
|accesscontrol|public|
|bug||
|bug-aone||

# 解决慢查询的最佳实践

慢查询通常会影响系统的性能和用户体验。为了有效优化这些查询，你需要仔细分析执行计划，评估索引的使用情况，改写 SQL 语句，甚至可能需要调整程序逻辑。

在本篇文章中，我们将介绍解决慢查询的最佳实践。

## 适用版本

适用于 OceanBase 数据库 V3.x 和 V4.x 版本。

## 关键概念

- 慢查询：执行时间较长的 SQL 查询。
- 执行计划：数据库为 SQL 语句生成的执行路径。
- 索引：用于加速数据检索的一种数据库对象。
- 分区：将数据库表分为多个部分以提高查询效率。
- 并行执行：同时在多个处理器上运行多个子任务以提高查询效率。
- 分库分表：将单表数据分散到多个数据库中以提升性能。
- 连接次序优化：通过调整多表连接顺序来优化SQL性能。

## OceanBase 数据库解决慢查询问题

OceanBase 数据库是一款原生分布式的 HTAP（混合事务/分析处理）数据库，专注于优化大规模查询场景。以下五种技术手段有效解决了慢查询问题。

### 方式一：通过并行执行

OceanBase 拥有成熟的并行执行能力，可以对普通查询、DDL、DML操作进行并行执行，并能灵活设置并行度。这使得开发者能够通过较少的 CPU 开销大幅提升 SQL 性能。

您可以手动设置并行执行，也可以自动设置并行执行。

* 手动设置并行

  + 使用 HINT `/*+ parallel(degree) */` 可以为整个 SQL 语句指定统一的并行度。

  + 或者在创建表时，可以使用如下语法设置表级并行度：

    ```sql
    create table big_table(c1 int) parallel = 32;
    ```

* 自动设置并行度

为了简化在使用 HINT 或建表时设置并行度的过程，OceanBase 数据库在 V4.2.1 版本中推出了 Auto DOP 功能。用户可以通过 HINT `/*+ parallel(auto) */` 或设置系统变量来启用 Auto DOP。启用后，数据库会根据租户配置和表的数据量自动计算合适的并行度，从而省去手动设置并行度的麻烦，并避免固定并行度可能引发的不合理情况。

用户可以根据实际业务需求调整并行参数 `parallel_degree_policy` 和 `parallel_servers_target`，以灵活控制并行度。具体参数说明如下：

- **parallel_degree_policy**：用于控制 Auto DOP 的开关。
- **parallel_servers_target**：表示租户在每个节点上可以申请的并行执行线程数量。

此外，您还可以通过以下 SQL 命令开启并设置自动并行度：

```sql
-- 开启并行
SET GLOBAL parallel_degree_policy = AUTO;

-- 设置基表最大扫描时间，单位为 ms，默认为 1000 ms；此处设置基表最大扫描时间为 100 ms，即基表扫描时间超过 100 ms 时，开启并行执行。
SET GLOBAL parallel_min_scan_time_threshold = 100;
```

### 方式二：利用 OceanBase 的原生分布式分区功能

OceanBase 数据库作为原生分布式数据库，其分区是独立的存储、高可用、事务单位，表的不同分区可以分布于不同服务器上，利用多机性能加快大表查询速度。同时，OceanBase 的原生分布式能力使应用程序可以像调用单机数据库一样使用，减少业务改造成本。

### 方式三：绑定执行计划

对于查询条件过滤性较差的 SQL，可以通过绑定执行计划来临时优化性能。然而，如果该 SQL 长期存在性能问题，建议对其逻辑进行修改，以确保长期效果。

#### 绑定执行计划

绑定执行计划将特定查询与其最优执行计划固定关联，适用于优化不足的查询。通过将某一具体 SQL 查询和其最优执行计划绑定，数据库在后续执行中直接使用该预设计划，从而降低优化开销，提升性能。

需要注意的是，绑定执行计划并非总是有效。如果数据分布或表结构发生变化，原有的绑定计划可能变得低效甚至导致查询性能下降。因此，建议定期审查绑定的执行计划，并根据需要进行更新或解绑。

- **上线前**：可在 SQL 语句中添加 Hint，控制优化器按照 Hint 指定的行为进行计划生成。

- **已上线业务**：如果优化器选择的计划效果不佳，可以通过绑定计划改善，而无需修改 SQL。这可以通过 DDL 操作将一组 Hint 加入到 SQL 中，使优化器生成更优计划，这组 Hint 称为 Outline。

   + 使用 SQL_TEXT 创建 Outline 的语法：

     ```sql
     CREATE [OR REPLACE] OUTLINE <outline_name> ON <stmt> [ TO <target_stmt> ];
     ```

   + 使用 SQL_ID 创建 Outline 的语法：

     ```sql
     CREATE OUTLINE outline_name ON sql_id USING HINT hint_text;
     ```

#### 修改 SQL 逻辑

OceanBase 数据库通过一系列优化机制，显著提升查询性能，用户在使用过程中几乎无感知。

- **多表连接场景**：对于多表连接的场景，OceanBase 实现了一套完备的连接枚举算法，能够灵活基于代价调整连接次序。可以高效处理内连接、外连接、反连接及半连接，甚至允许转换连接类型。

- **子查询场景**：OceanBase 数据库查询改写模块提供了多种子查询优化策略，针对嵌套层次不深的子查询，能够将其转换为连接，并采取不同的连接算法进行优化。这使得子查询的执行效率得到了显著提升，确保整体查询性能的优化。

- **大表聚合场景**：大表聚合是一个典型的性能优化场景，OceanBase具备预聚合优化能力，能够将大表数据拆分成多个组进行聚合处理，再进行最终汇总。结合并行执行，预聚合可以极大地提升执行效率，通常能提高数倍的性能。


## 实践总结

通过开启并行执行、利用 OceanBase 的原生分布式分区功能等实际操作，以及无感知的多表连接次序优化、子查询优化、大表聚合优化、TP 和 AP 隔离等技术，OceanBase 数据库能够有效解决 MySQL 慢查询问题。

## 相关文档

- [性能调优概述](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000001049896)以及它的子章节均提供了详细的文档资料，介绍了 OceanBase 的性能调优技术架构。
- 参考指南总章下的[性能调优](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000001050803)以及子章节均提供了详细的文档资料，介绍了 OceanBase 的性能调优的使用方法。
