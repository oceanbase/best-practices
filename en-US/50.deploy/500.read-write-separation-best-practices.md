# Best practices for read/write splitting

To alleviate the read and write workload on enterprise databases and minimize the mutual impact of read and write operations, OceanBase Database provides read/write splitting capabilities. By handling read and write operations separately, OceanBase Database speeds up system response and helps enterprises build efficient and stable database systems. This topic explains how to implement and configure read/write splitting in OceanBase Database based on the weak-consistency read strategy.

## Best practices for read/write splitting in OceanBase Database V4.X

### Weak-consistency read

A distributed database system supports multiple types of consistency read strategies due to its natural multi-replica feature. The strong-consistency read strategy ensures the linearity of read operations so that the latest data can always be read. However, the weak-consistency read strategy cannot ensure that the latest data is read every time.

OceanBase Database is a distributed database system built on the Multi-Paxos protocol, where data is stored in multiple replicas across different zones or nodes. During data updates, the leader replica executes the modification statements and synchronizes the commit logs (clogs) to follower replicas. The commit of a transaction is considered successful provided that logs of the majority of replicas, including the leader, are persisted to the disk. During this process, logs of replicas other than the leader are also persisted to ensure the disaster recovery capability. However, the update and replay for the followers are not necessarily completed after logs of the majority of replicas other than the leader are persisted to the disk. Therefore, the data of some replicas may be out-of-sync with that of the leader.

OceanBase Database provides two consistency levels: STRONG and WEAK. In a strong-consistency read operation, requests are routed to the leader to read the latest data. In a weak-consistency read operation, the reading of the latest data is not required, and requests are preferentially routed to the followers. In OceanBase Database, write operations always feature strong consistency, which means that write services are always provided by the leader. By default, read operations in OceanBase Database feature strong consistency and therefore read services are provided by the leader. However, you can specify weak-consistency reads. In this case, the followers preferentially provide read services.

In a scenario where the business is insensitive to data timeliness, OceanBase Database writes data to the leader and reads data from a follower, making full use of resources and improving the database read efficiency. In this scenario, data is read from a follower in weak consistency mode. You can use the tenant-level parameter [max_stale_time_for_weak_consistency](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001376345) to specify the maximum lag time of weak-consistency reads. This is also known as a bounded staleness consistency read. It ensures that the read data is out-of-sync with the latest data by less than the specified period. By default, the period is 5s. If a replica lags behind the latest data by more than the specified time, the replica is unreadable, and the retry mechanism retries other valid replicas. If all replicas are unreadable, the retry mechanism continues to retry the replicas until the statement times out.

Different weak-consistency read requests are routed to different replicas. Even if data of different replicas is read in bounded staleness consistency mode, the staleness of data read by different requests is uncertain. To solve this problem, OceanBase Database provides the monotonic read feature. You can use the tenant-level parameter [enable_monotonic_weak_read](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001376370) to specify whether to enable this feature. If this feature is enabled, after a process obtains a value of a data object, the subsequent access will not return values of versions earlier than that of the obtained value. This ensures the monotonicity of data versions in weak-consistency read mode.

### Read/Write splitting within a cluster

In an OceanBase cluster, SQL read and write requests are routed to the leader by default. To reduce the workload of leaders and make full use of resources, you can deploy OceanBase Database Proxy (ODP) in a multi-replica cluster. This setup routes strong-consistency read and write requests to the leader, while weak-consistency reads are handled by nearby followers.

A business system can initiate both strong-consistency and weak-consistency read requests to the database. Therefore, to implement read/write splitting within a cluster, you must set the system to distinguish between these two types of SQL requests. In other words, weak-consistency reads are executed at the SQL level. Generally, you can configure the following settings in an application:

* Specify to apply the weak-consistency read strategy to read-only SQL read requests.

* Specify to apply the weak-consistency read strategy to all SQL read requests in the current session.

In addition, ODP allows you to specify the destination replicas for weak-read consistency requests based on the physical locations and types of replicas.

#### Configure parameters of weak-consistency reads

You must configure the following parameters based on your business environment before you configure weak-consistency reads.

| Parameter | Default value | Scope | Description | Suggestion and impact |
|------------------------------------|-------------|----------|------------------------------|--------------------------------------|
|enable_monotonic_weak_read          | False       | Tenant   | Specifies whether to enable monotonic reads.                 | Modify this parameter based on your business scenario.              |
|max_stale_time_for_weak_consistency | 5s        | Tenant   | The maximum lag time of weak-consistency reads.       | We recommend that you use the default value. |
|weak_read_version_refresh_interval  | 50 ms     | Cluster   | The interval for refreshing the weak-consistency read version.      | <ul><li>We recommend that you use the default value. </li> <li>The value `0` specifies to disable monotonic reads. </li> <li>If the value is greater than that of the `max_stale_time_for_weak_consistency` parameter, weak-consistency reads are not supported due to excessively long lag time of the follower. </li></ul> |

#### Select a routing strategy for read/write splitting

You can configure either of the following routing strategies for weak-consistency read requests from applications to an OceanBase cluster:

* Load-balanced routing: Weak-consistency read requests are evenly routed to the leader and followers in load balancing mode.

* Follower-first read: Weak-consistency read requests from the client are preferentially routed to nearby followers.

##### Load-balanced routing

This strategy is the default setting, which applies automatically when you configure weak-consistency reads for your application. This means you only need to specify weak-consistency reads in your SQL statements, with no additional configuration required. It applies to weak-consistency reads in clusters with standard deployment.

You can specify the weak-consistency read strategy for SQL statements by using one of the following methods:

* Use a hint in an SQL statement.

  The setting only applies to the SQL statement. Here is an example:

  ```shell
  obclient> SELECT /*+read_consistency(weak)*/ * FROM t1;
  ```

* Use a session-level variable.

  The setting only applies to the current session. Here is an example:

  ```shell
  obclient> SET ob_read_consistency='weak';
  ```

* Use a global variable.

  The setting applies to all connections to the tenant. Here is an example:

  ```shell
  obclient> SET GLOBAL ob_read_consistency='weak';
  ```

<main id="notice" type='explain'>
<h4>Note</h4>
<p>An application can initiate both strong-consistency and weak-consistency read requests to the database. Therefore, we recommend that you use either of the first two methods. </p>
</main>

##### Follower-first read

You can use the ODP parameter `proxy_route_policy` or user variable `proxy_route_policy` to specify this strategy. To do so, follow these steps:

1. Configure logical data center (LDC) settings, including `REGION` and `IDC`, for all zones in the cluster.

   If you do not specify `REGION` or `IDC` when you deploy an OceanBase cluster, the default value `default_region` of `REGION` is used, and `IDC` is left empty. You can specify `REGION` and `IDC` for a zone in the following way:

   1. Log in to the `sys` tenant of the cluster as the `root` user.

   2. Execute the `ALTER SYSTEM MODIFY ZONE` statement to modify `REGION` and `IDC` for the zone.

      In the following example, `REGION` specifies the city name, which is case-sensitive. `IDC` specifies the data center of the zone. Generally, you need to set this parameter to the data center name in lowercase. `z1` specifies the zone name. An OceanBase cluster has several regions. A region has several zones. A zone has an `IDC` attribute.

      ```shell
      obclient> ALTER SYSTEM MODIFY ZONE z1 SET REGION= 'SHANGHAI';
      ```

      ```shell
      obclient> ALTER SYSTEM MODIFY ZONE z1 SET IDC = 'zue';
      ```

   3. Verify the settings.

       ```shell
       obclient> SELECT * FROM oceanbase.DBA_OB_ZONES;
       ```

2. Configure LDC settings for ODP.

   1. Use ODP to log in to the `sys` tenant of the cluster as the `root` user.

   2. Execute the `ALTER PROXYCONFIG` statement to modify `IDC` for ODP.

      In the following example, `proxy_idc_name` specifies the name of the IDC where ODP is deployed. It helps you determine whether ODP is deployed in the same IDC as the OBServer node. This way, you can select a routing strategy based on the routing rule to route requests to the ODP node in the same IDC.

      ```shell
      obclient> ALTER PROXYCONFIG SET proxy_idc_name='zue';
      ```
   
   3. Verify the settings.

      ```shell
      obclient> SHOW PROXYINFO IDC;
      ```

3. Configure an ODP routing strategy for weak-consistency read requests.

   1. Use ODP to log in to the `sys` tenant of the cluster as the `root` user.

   2. Configure a routing strategy for ODP.

      You can configure the routing strategy using the ODP parameter `proxy_route_policy` or the user variable `proxy_route_policy`. The routing options are as follows:

      * `follower_first`: This is the default setting, which prioritizes routing weak-consistency read requests to follower replicas, even if they are undergoing major compactions. If no follower replicas are available, the requests will be routed to the leader replica.
      * `follower_only`: This setting routes weak-consistency read requests exclusively to follower replicas. If no follower replicas are available, the connection to the client will be terminated.

      Here are some examples:

      * Use the ODP parameter `proxy_route_policy` to prioritize routing weak-consistency read requests to the follower replica in the same IDC.

        This setting applies to all sessions.

        ```shell
        obclient> ALTER PROXYCONFIG SET proxy_route_policy='follower_first';
        ```

      * Use the user variable `proxy_route_policy` to prioritize routing weak-consistency read requests to the follower replica in the same IDC.

        This setting needs to be configured in each session.

        ```shell
        obclient> SET @proxy_route_policy='follower_first';
        ```

   3. Verify the settings.

      ```shell
      obclient> SHOW PROXYSESSION VAARIABLES;
      ```

4. Configure the weak-consistency read strategy for SQL statements.

   1. Use ODP to log in to the cluster from a user tenant.

   2. Specify the weak-consistency read strategy for SQL statements.

      * Use a hint in an SQL statement.

        The setting only applies to the SQL statement. Here is an example:

        ```shell
        obclient> SELECT /*+read_consistency(weak)*/ * FROM t1;
        ```

      * Use a session-level variable.

        The setting only applies to the current session. Here is an example:

        ```shell
        obclient> SET ob_read_consistency='weak';
        ```

      * Use a global variable.

        The setting applies to all connections to the tenant. Here is an example:

        ```shell
        obclient> SET GLOBAL ob_read_consistency='weak';
        ```

    <main id="notice" type='explain'>
    <h4>Note</h4>
    <p>An application can initiate both strong-consistency and weak-consistency read requests to the database. Therefore, we recommend that you use either of the first two methods. </p>
    </main>

#### Follower latency threshold

In a read/write splitting scenario, ODP preferentially forwards weak-consistency read requests to a follower. As the data saved by a follower lags behind the latest data of the leader, a weak-consistency read request may not read the latest data from a follower. ODP and OceanBase Database provide the follower latency threshold feature for you to specify the maximum latency allowed for data read by weak-consistency read requests. For more information, see [Follower latency threshold](https://en.oceanbase.com/docs/common-odp-doc-en-10000000001177451).

### Configure the weak-consistency read strategy for drivers

#### OceanBase Connector/J

OceanBase Connector/J (JDBC) supports setting weak-consistency reads by adding `sessionVariables=ob_read_consistency=weak` to a URL. This means that you can specify weak-consistency reads by setting a session-level variable in JDBC, and this setting will only apply to the current session. If you want all requests through this JDBC connection to perform weak-consistency reads, you can set this parameter. Here is an example:

```shell
jdbc:oceanbase://172.xx.xx.xx:2881/test?useSSL=false&useServerPrepStmts=true&sessionVariables=ob_read_consistency=weak
```

For more information about how to use OceanBase Connector/J to connect to OceanBase Database, see [Build a Java application](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001375517).

#### OceanBase Connector/ODBC

You can specify the weak-consistency read strategy for OceanBase Connector/ODBC by using SQL statements or database variables.

### Verify the execution of weak-consistency reads of SQL statements

You can query the `consistency_level` column in the `GV$OB_SQL_AUDIT` view to check whether an SQL statement executed a weak-consistency read. Here is an example:

1. Create a table named `tbl1`.

   ```shell
   obclient> CREATE TABLE tbl1(id int);
   ```

2. Insert data into the table and commit the transaction.

   ```shell
   obclient> INSERT INTO tbl1 VALUES(100);
   ```

   ```shell
   obclient> COMMIT;
   ```

3. Execute the following SQL statements.

   ```shell
   obclient> SELECT * FROM tbl1;
   ```

   ```shell
   obclient> SELECT /*+read_consistency(weak)*/ * FROM tbl1;
   ```

4. Query the `GV$SQL_AUDIT` view.

   ```shell
   obclient> SELECT svr_ip,query_sql,consistency_level FROM oceanbase.GV$OB_SQL_AUDIT WHERE query_sql LIKE '%FROM tbl1';
   ```

   A sample query result is as follows:

   ```shell
   +----------------+------------------------------------------------+-------------------+
   | svr_ip         | query_sql                                      | consistency_level |
   +----------------+------------------------------------------------+-------------------+
   | 172.xx.xx.34   | SELECT * FROM tbl1                             |                 3 |
   | 172.xx.xx.35   | SELECT /*+read_consistency(weak)*/ * FROM tbl1 |                 2 |
   +----------------+------------------------------------------------+-------------------+
   2 rows in set
   ```

   In the query result, the value `3` indicates a strong-consistency read, and the value `2` indicates a weak-consistency read.

## Best practices for read/write splitting in OceanBase Database V3.X

### Weak-consistency read

A distributed database system supports multiple types of consistency read strategies due to its natural multi-replica feature. The strong-consistency read strategy ensures the linearity of read operations so that the latest data can always be read. However, the weak-consistency read strategy cannot ensure that the latest data is read every time.

OceanBase Database is a distributed database system built on the Multi-Paxos protocol, where data is stored in multiple replicas across different zones or nodes. During data updates, the leader replica executes the modification statements and synchronizes the commit logs (clogs) to follower replicas. The commit of a transaction is considered successful provided that logs of the majority of replicas, including the leader, are persisted to the disk. During this process, logs of replicas other than the leader are also persisted to ensure the disaster recovery capability. However, the update and replay for the followers are not necessarily completed after logs of the majority of replicas other than the leader are persisted to the disk. Therefore, the data of some replicas may be out-of-sync with that of the leader.

OceanBase Database provides two consistency levels: STRONG and WEAK. In a strong-consistency read operation, requests are routed to the leader to read the latest data. In a weak-consistency read operation, the reading of the latest data is not required, and requests are preferentially routed to the followers. In OceanBase Database, write operations always feature strong consistency, which means that write services are always provided by the leader. By default, read operations in OceanBase Database feature strong consistency and therefore read services are provided by the leader. However, you can specify weak-consistency reads. In this case, the followers preferentially provide read services.

In a scenario where the business is insensitive to data timeliness, OceanBase Database writes data to the leader and reads data from a follower, making full use of resources and improving the database read efficiency. In this scenario, data is read from a follower in weak consistency mode. You can use the tenant-level parameter [max_stale_time_for_weak_consistency](https://en.oceanbase.com/docs/enterprise-oceanbase-database-en-10000000000850168) to specify the maximum lag time of weak-consistency reads. This is also known as a bounded staleness consistency read. It ensures that the read data is out-of-sync with the latest data from the primary cluster by more than a specified period. By default, the period is 5s. If the standby cluster lags behind the latest data by more than the specified time, the read operation will retry and wait until it either times out, the standby cluster catches up with the primary cluster, or another replica (primary cluster) is chosen.

Different weak-consistency read requests are routed to different replicas. Even if data of different replicas is read in bounded staleness consistency mode, the staleness of data read by different requests is uncertain. To solve this problem, OceanBase Database provides the monotonic read feature. You can use the tenant-level parameter [enable_monotonic_weak_read](https://en.oceanbase.com/docs/enterprise-oceanbase-database-en-10000000000850164) to specify whether to enable this feature. If this feature is enabled, after a process obtains a value of a data object, the subsequent access will not return values of versions earlier than that of the obtained value. This ensures the monotonicity of data versions in weak-consistency read mode.

### Read/Write splitting within a cluster

In an OceanBase cluster, SQL read and write requests are routed to the leader by default. To reduce the workload of leaders and make full use of resources, you can deploy OceanBase Database Proxy (ODP) in a multi-replica cluster. This setup routes strong-consistency read and write requests to the leader, while weak-consistency reads are handled by nearby followers.

A business system can initiate both strong-consistency and weak-consistency read requests to the database. Therefore, to implement read/write splitting within a cluster, you must set the system to distinguish between these two types of SQL requests. In other words, weak-consistency reads are executed at the SQL level. Generally, you can configure the following settings in an application:

* Specify to apply the weak-consistency read strategy to read-only SQL read requests.

* Specify to apply the weak-consistency read strategy to all SQL read requests in the current session.

In addition, ODP allows you to specify the destination replicas for weak-read consistency requests based on the physical locations and types of replicas.

#### Configure parameters of weak-consistency reads

You must configure the following parameters based on your business environment before you configure weak-consistency reads.

| Parameter | Default value | Scope | Description | Suggestion and impact |
|------------------------------------|-------------|----------|------------------------------|--------------------------------------|
|enable_monotonic_weak_read          | False       | Tenant   | Specifies whether to enable monotonic reads.                 | Modify this parameter based on your business scenario.              |
|max_stale_time_for_weak_consistency | 5s        | Tenant   | The maximum lag time of weak-consistency reads.       | We recommend that you use the default value. |
|weak_read_version_refresh_interval  | 50 ms     | Cluster   | The interval for refreshing the weak-consistency read version.      | <ul><li>We recommend that you use the default value. </li> <li>The value `0` specifies to disable monotonic reads. </li> <li>If the value is greater than that of the `max_stale_time_for_weak_consistency` parameter, weak-consistency reads are not supported due to excessively long lag time of the follower. </li></ul> |

#### Select a routing strategy for read/write splitting

You can configure either of the following routing strategies for weak-consistency read requests from applications to an OceanBase cluster:

* Load-balanced routing: Weak-consistency read requests are evenly routed to the leader and followers in load balancing mode.

* Follower-first read: Weak-consistency read requests from the client are preferentially routed to nearby followers.

##### Load-balanced routing

This strategy is the default setting, which applies automatically when you configure weak-consistency reads for your application. This means you only need to specify weak-consistency reads in your SQL statements, with no additional configuration required. It applies to weak-consistency reads in clusters with standard deployment.

You can specify the weak-consistency read strategy for SQL statements by using one of the following methods:

* Use a hint in an SQL statement.

  The setting only applies to the SQL statement. Here is an example:

  ```shell
  obclient> SELECT /*+read_consistency(weak)*/ * FROM t1;
  ```

* Use a session-level variable.

  The setting only applies to the current session. Here is an example:

  ```shell
  obclient> SET ob_read_consistency='weak';
  ```

* Use a global variable.

  The setting applies to all connections to the tenant. Here is an example:

  ```shell
  obclient> SET GLOBAL ob_read_consistency='weak';
  ```

<main id="notice" type='explain'>
<h4>Note</h4>
<p>An application can initiate both strong-consistency and weak-consistency read requests to the database. Therefore, we recommend that you use either of the first two methods. </p>
</main>

##### Follower-first read

You can use the ODP parameter `proxy_route_policy` or user variable `proxy_route_policy` to specify this strategy. To do so, follow these steps:

1. Configure LDC settings, including `REGION` and `IDC`, for all zones in the cluster.

   If you do not specify `REGION` or `IDC` when you deploy an OceanBase cluster, the default value `default_region` of `REGION` is used, and `IDC` is left empty. You can specify `REGION` and `IDC` for a zone in the following way:

   1. Log in to the `sys` tenant of the cluster as the `root` user.

   2. Execute the `ALTER SYSTEM MODIFY ZONE` statement to modify `REGION` and `IDC` for the zone.

      In the following example, `REGION` specifies the city name, which is case-sensitive. `IDC` specifies the data center of the zone. Generally, you need to set this parameter to the data center name in lowercase. `z1` specifies the zone name. An OceanBase cluster has several regions. A region has several zones. A zone has an `IDC` attribute.

      ```shell
      obclient> ALTER SYSTEM MODIFY ZONE z1 SET REGION= 'SHANGHAI';
      ```

      ```shell
      obclient> ALTER SYSTEM MODIFY ZONE z1 SET IDC = 'zue';
      ```

    3. Verify the settings.

       ```shell
       obclient> SELECT * FROM oceanbase.__all_zone;
       ```

2. Configure LDC settings for ODP.

   1. Use ODP to log in to the `sys` tenant of the cluster as the `root` user.

   2. Execute the `ALTER PROXYCONFIG` statement to modify `IDC` for ODP.
   
      In the following example, `proxy_idc_name` specifies the name of the IDC where ODP is deployed. It helps you determine whether ODP is deployed in the same IDC as the OBServer node. This way, you can select a routing strategy based on the routing rule to route requests to the ODP node in the same IDC.

      ```shell
      obclient> ALTER PROXYCONFIG SET proxy_idc_name='zue';
      ```
   
   3. Verify the settings.

      ```shell
      obclient> SHOW PROXYINFO IDC;
      ```

3. Configure an ODP routing strategy for weak-consistency read requests.

   1. Use ODP to log in to the `sys` tenant of the cluster as the `root` user.

   2. Configure a routing strategy for ODP.

      You can configure the routing strategy using the ODP parameter `proxy_route_policy` or the user variable `proxy_route_policy` to specify the routing strategy. The routing options are as follows:

      * `follower_first`:  This is the default setting, which prioritizes routing weak-consistency read requests to follower replicas, even if they are undergoing major compactions. If no follower replicas are available, the requests will be routed to the leader replica.
      * `follower_only`: This setting routes weak-consistency read requests exclusively to follower replicas. If no follower replicas are available, the connection to the client will be terminated.

      Here are some examples:

      * Use the ODP parameter `proxy_route_policy` to prioritize routing weak-consistency read requests to the follower replica in the same IDC.

        The setting applies to all sessions.

        ```shell
        obclient> ALTER PROXYCONFIG SET proxy_route_policy='follower_first';
        ```
      
      * Use the user variable `proxy_route_policy` to prioritize routing weak-consistency read requests to the follower replica in the same IDC.

        The setting only applies to the current session.

        ```shell
        obclient> SET @proxy_route_policy='follower_first';
        ```

   3. Verify the settings.

      ```shell
      obclient> SHOW PROXYSESSION VAARIABLES;
      ```

4. Configure the weak-consistency read strategy for SQL statements.

   1. Use ODP to log in to the cluster from a user tenant.

   2. Specify the weak-consistency read strategy for SQL statements.

      * Use a hint in an SQL statement.

        The setting only applies to the SQL statement. Here is an example:

        ```shell
        obclient> SELECT /*+read_consistency(weak)*/ * FROM t1;
        ```

      * Use a session-level variable.

        The setting only applies to the current session. Here is an example:

        ```shell
        obclient> SET ob_read_consistency='weak';
        ```

      * Use a global variable.

        The setting applies to all connections to the tenant. Here is an example:

        ```shell
        obclient> SET GLOBAL ob_read_consistency='weak';
        ```

    <main id="notice" type='explain'>
    <h4>Note</h4>
    <p>An application can initiate both strong-consistency and weak-consistency read requests to the database. Therefore, we recommend that you use either of the first two methods. </p>
    </main>

### Read/Write splitting between primary and standby clusters

In conventional databases, many read-only report applications are insensitive to data timeliness. The database administrator (DBA) can route requests of such applications to a standby database for execution. This reduces the workload of the primary database while meeting the requirements of statistical queries. In the primary/standby architecture of OceanBase Database, you can use standby clusters to achieve the preceding purpose. You can also use ODP to route read requests to nearby replicas in the local IDC.

#### Configure the weak-consistency read strategy for a standby cluster

A standby cluster provides the weak-consistency read feature like a follower replica in the primary cluster. However, the load-balanced routing strategy for the leader and follower replicas is not applicable to a standby cluster because it contains only followers. You can configure the weak-consistency read strategy for a standby cluster in the following way:

1. Log in to the `sys` tenant of the standby cluster as the `root` user.

2. Set the tenant-level parameters `enable_monotonic_weak_read` and `max_stale_time_for_weak_consistency` to configure weak-consistency reads.

3. Specify the weak-consistency reads at the SQL level.

    * Use a hint in an SQL statement.

      The setting only applies to the SQL statement. Here is an example:

      ```shell
      obclient> SELECT /*+read_consistency(weak)*/ * FROM t1;
      ```

    * Use a session-level variable.

      The setting only applies to the current session. Here is an example:

      ```shell
      obclient> SET ob_read_consistency='weak';
      ```

<main id="notice" type='notice'>
<h4>Notice</h4>
<p>A user tenant of a standby cluster supports only weak-consistency reads. If a strong-consistency read, write, or DDL operation is initiated for a user tenant, an error is returned. </p>
</main>

#### Configure read/write splitting

Two read/write splitting modes are available:

* Specify to read data from only a standby cluster: This mode applies to delay-insensitive statistical query applications. It makes full use of resources of a standby cluster to support decision-making based on a large amount of data.

* Specify to write data to the primary cluster and read data from a standby cluster:

  In this mode, read/write splitting is implemented by applications. ODP and OceanBase Database do not support this mode.

This section describes how to configure read/write splitting in the first mode.

##### Configuration of a standby cluster

1. Configure LDC settings, including `REGION` and `IDC`, for all zones in the standby cluster.

   You can specify `REGION` and `IDC` for a zone in the following way:

   1. Log in to the `sys` tenant of the standby cluster as the `root` user.

   2. Execute the `ALTER SYSTEM MODIFY ZONE` statement to modify `REGION` and `IDC` for the zone.

      In the following example, `REGION` specifies the city name, which is case-sensitive. `IDC` specifies the data center of the zone. Generally, you need to set this parameter to the data center name in lowercase. `z1` specifies the zone name. An OceanBase cluster has several regions. A region has several zones. A zone has an `IDC` attribute.

      ```shell
      obclient> ALTER SYSTEM MODIFY ZONE z1 SET REGION= 'SHANGHAI';
      ```

      ```shell
      obclient> ALTER SYSTEM MODIFY ZONE z1 SET IDC = 'zue';
      ```

    3. Verify the settings.

       ```shell
       obclient> SELECT * FROM oceanbase.__all_zone;
       ```

2. Configure LDC settings for ODP.

   1. Use ODP to log in to the `sys` tenant of the standby cluster as the `root` user.

   2. Execute the `ALTER PROXYCONFIG` statement to modify `IDC` for ODP.
   
      In the following example, `proxy_idc_name` specifies the name of the IDC where ODP is deployed. It helps you determine whether ODP is deployed in the same IDC as the OBServer node. This way, you can select a routing strategy based on the routing rule to route requests to the ODP node in the same IDC.

      ```shell
      obclient> ALTER PROXYCONFIG SET proxy_idc_name='zue';
      ```
   
   3. Verify the settings.

      ```shell
      obclient> SHOW PROXYINFO IDC;
      ```

3. Set tenant-level parameters to control weak-consistency reads for the standby cluster.

   1. Use ODP to log in to the `sys` tenant of the standby cluster as the `root` user.

   2. Execute the following statements to specify the parameters.

      ```shell
      obclient> ALTER SYSTEM SET enable_monotonic_weak_read = true TENANT=mysqltenant;
      ```

      ```shell
      obclient> ALTER SYSTEM SET max_stale_time_for_weak_consistency ='10s' TENANT=mysqltenant;
      ```

      <main id="notice" type='explain'>
      <h4>Note</h4>
      <p>You can specify <code>TENANT=all</code> to apply the modification to all tenants in the standby cluster. </p>
      </main>

4. Configure the weak-consistency read strategy for applications.

   You can specify the weak-consistency read strategy at the SQL level or for JDBC sessions. For more information about how to specify the weak-consistency read attribute in the connection string of a JDBC session, see the **Configure the weak-consistency read strategy for drivers** section.

   To specify the weak-consistency read strategy at the SQL level, perform the following operations:

   1. Use ODP to log in to the standby cluster from a user tenant.

   2. Specify the weak-consistency read strategy for SQL statements.

      * Use a hint in an SQL statement.

        The setting only applies to the SQL statement. Here is an example:

        ```shell
        obclient> SELECT /*+read_consistency(weak)*/ * FROM t1;
        ```

      * Use a session-level variable.

        The setting only applies to the current session. Here is an example:

        ```shell
        obclient> SET ob_read_consistency='weak';
        ```

##### Configuration of ODP

The primary and standby clusters have the same cluster name. If you specified to start ODP based on ConfigUrl in OceanBase Cloud Platform (OCP), SQL requests will be routed to the primary cluster by default when you use ODP to connect to the database. You can configure ODP to access a standby cluster by using either of the following methods:

* Method 1: Specify `cluster_id` of the standby cluster in the cluster name contained in the username for accessing the database. In other words, specify the username in the format of `username@tenant_name#cluster_name:cluster_id`. You can obtain `cluster_id` from the cluster list in the OCP console.

   Here is an example:

   ```shell
   obclient -h10.10.10.1 -u*****@obtenant#obdemo:xxxx -P2883 -p****** -c -A oceanbase
   ```

* Method 2: Use OCP to configure an OBProxy that accesses a standby cluster by default. You can specify to start the OBProxy in `RsList` mode, and select the standby cluster as the accessible OceanBase cluster.

  For more information, see [Create an OBProxy cluster](https://en.oceanbase.com/docs/common-ocp-10000000001553984).

##### Configuration of applications

When you connect to the database from an application through a JDBC connection, if you want to specify the weak-consistency read strategy for the application without adding a hint to the application code, you can specify the weak-consistency read attribute in the JDBC connection string. For more information, see the **Configure the weak-consistency read strategy for drivers** section.

### Configure the weak-consistency read strategy for drivers

#### OceanBase Connector/J

OceanBase Connector/J (JDBC) allows you to specify weak-consistency reads by adding `sessionVariables=ob_read_consistency=weak` to a URL. The setting only applies to the current session. It applies the weak-consistency read strategy to all requests sent to the database through the JDBC connection. Here is an example:

```shell
jdbc:oceanbase://172.xx.xx.xx:2881/test?useSSL=false&useServerPrepStmts=true&sessionVariables=ob_read_consistency=weak
```

For more information about how to use OceanBase Connector/J to connect to OceanBase Database, see [Build a Java application](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001375517).

#### OceanBase Connector/ODBC

You can specify the weak-consistency read strategy for OceanBase Connector/ODBC by using SQL statements or database variables.

### Verify the execution of weak-consistency reads of SQL statements

You can query the `consistency_level` column in the `GV$SQL_AUDIT` view to check whether an SQL statement executed a weak-consistency read. Here is an example:

1. Create a table named `tbl1`.

   ```shell
   obclient> CREATE TABLE tbl1(id int);
   ```

2. Insert data into the table and commit the transaction.

   ```shell
   obclient> INSERT INTO tbl1 VALUES(100);
   ```

   ```shell
   obclient> COMMIT;
   ```

3. Execute the following SQL statements.

   ```shell
   obclient> SELECT * FROM tbl1;
   ```

   ```shell
   obclient> SELECT /*+read_consistency(weak)*/ * FROM tbl1;
   ```

4. Query the `GV$SQL_AUDIT` view.

   ```shell
   obclient> SELECT svr_ip,query_sql,consistency_level FROM oceanbase.GV$SQL_AUDIT WHERE query_sql LIKE '%FROM tbl1';
   ```

   A sample query result is as follows:

   ```shell
   +----------------+------------------------------------------------+-------------------+
   | svr_ip         | query_sql                                      | consistency_level |
   +----------------+------------------------------------------------+-------------------+
   | 172.xx.xx.34   | SELECT * FROM tbl1                             |                 3 |
   | 172.xx.xx.35   | SELECT /*+read_consistency(weak)*/ * FROM tbl1 |                 2 |
   +----------------+------------------------------------------------+-------------------+
   2 rows in set
   ```

   In the query result, the value `3` indicates a strong-consistency read, and the value `2` indicates a weak-consistency read.